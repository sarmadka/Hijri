صنف نـافذة_أوقات_الصلاة {
    @حقنة عرف مركب: مـركب؛
    عرف إشعار_التحميل: سـندنا[كـتابة]؛
    عرف نص_الموقع: سـندنا[كـتابة]؛
    عرف نص_الفجر: سـندنا[كـتابة]؛
    عرف نص_الشروق: سـندنا[كـتابة]؛
    عرف نص_الظهر: سـندنا[كـتابة]؛
    عرف نص_العصر: سـندنا[كـتابة]؛
    عرف نص_المغرب: سـندنا[كـتابة]؛
    عرف نص_العشاء: سـندنا[كـتابة]؛
    عرف النداء: نـداء_آمن؛

    عملية هذا~هيئ(
        السنة_الهجرية: صـحيح،
        الشهر_الهجري: صـحيح،
        اليوم_الهجري: صـحيح
    ) {
        عرف الكائن: سند[هذا_الصنف](هذا)؛
        // تحويل التاريخ الهجري إلى ميلادي
        عرف تاريخ_ميلادي: هـجري.تـاريخ = هـجري.حول_لميلادي(
            السنة_الهجرية،
            الشهر_الهجري،
            اليوم_الهجري
        )؛

        عرف العنوان: نـص = نـص.املأ("أوقات الصلاة ليوم\ج%i %s %i هـ"،
            اليوم_الهجري،
            الأشهر_الهجرية(الشهر_الهجري - 1)،
            السنة_الهجرية
        )؛

        هذا.المشهد = صـندوق().{
            الطراز.{
                العرض = مـسافة.مئوي(100)؛
                الطول = مـسافة.مئوي(100)؛
                الإظهار = إظـهار._مرن_؛
                ملء_السطر = مـلء_سطر._وسط_؛
                المحاذاة = مـحاذاة._وسط_؛
            }؛
            أضف_فروع({
                صـندوق().{
                    الطراز.{
                        ظل_الصندوق = ظـل_صندوق(
                            مـسافة.بكسلات(0), مـسافة.بكسلات(0), مـسافة.بكسلات(70), مـسافة.بكسلات(20), لـون("0004")
                        );
                        الخلفية = خـلفية(لـون("ffffff"))؛
                        الحشوة = مـسافة4.بكسلات(30)؛
                        نصف_قطر_الإطار = مـسافة4.بكسلات(10)؛
                        أدنى_عرض = مـسافة.بكسلات(250)؛
                        الإظهار = إظـهار._مرن_؛
                        النسق = نـسق._عمود_؛
                    }؛
                    أضف_فروع({
                        // العنوان
                        كـتابة(العنوان).{
                            الطراز.{
                                لون_الخط = لـون("2c3e50")؛
                                حجم_الخط = مـسافة.بكسلات(24.0)؛
                                فئة_الخط = "TajawalBold"؛
                                سمك_الخط = 700؛
                                الهامش = مـسافة4.بكسلات(0، 0، 10، 0)؛
                                محاذاة_النص = مـحاذاة_نص._وسط_؛
                            }
                        }،
                        // الموقع (المدينة والبلد)
                        كـتابة(نـص("")).{
                            الكائن.نص_الموقع = هذا؛
                            الطراز.{
                                لون_الخط = لـون("7f8c8d")؛
                                حجم_الخط = مـسافة.بكسلات(14.0)؛
                                محاذاة_النص = مـحاذاة_نص._وسط_؛
                                الهامش = مـسافة4.بكسلات(0، 0، 15، 0)؛
                            }
                        }،
                        // رسالة التحميل
                        كـتابة(نـص("جاري تحميل أوقات الصلاة...")).{
                            الكائن.إشعار_التحميل = هذا؛
                            الطراز.{
                                لون_الخط = لـون("95a5a6")؛
                                حجم_الخط = مـسافة.بكسلات(14.0)؛
                                محاذاة_النص = مـحاذاة_نص._وسط_؛
                            }
                        }،
                        // أوقات الصلاة
                        صـندوق().{
                            الطراز.{
                                الإظهار = إظـهار._مرن_؛
                                النسق = نـسق._عمود_؛
                                الفجوة = مـسافة.بكسلات(15)؛
                                الهامش = مـسافة4.بكسلات(20، 0، 0، 0)؛
                            }؛
                            أضف_فروع({
                                // الفجر
                                صـندوق().{
                                    الطراز.{
                                        الإظهار = إظـهار._مرن_؛
                                        النسق = نـسق._سطر_؛
                                        ملء_السطر = مـلء_سطر._مسافة_بينية_؛
                                        الحشوة = مـسافة4.بكسلات(15)؛
                                        الخلفية = خـلفية(لـون("ecf0f1"))؛
                                        نصف_قطر_الإطار = مـسافة4.بكسلات(8)؛
                                    }؛
                                    أضف_فروع({
                                        كـتابة(نـص("الفجر")).{
                                            الطراز.{
                                                لون_الخط = لـون("2c3e50")؛
                                                حجم_الخط = مـسافة.بكسلات(16.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }،
                                        كـتابة(نـص("--:--")).{
                                            الكائن.نص_الفجر = هذا؛
                                            الطراز.{
                                                لون_الخط = لـون("27ae60")؛
                                                حجم_الخط = مـسافة.بكسلات(18.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }
                                    })؛
                                }،
                                // الشروق
                                صـندوق().{
                                    الطراز.{
                                        الإظهار = إظـهار._مرن_؛
                                        النسق = نـسق._سطر_؛
                                        ملء_السطر = مـلء_سطر._مسافة_بينية_؛
                                        الحشوة = مـسافة4.بكسلات(15)؛
                                        الخلفية = خـلفية(لـون("ecf0f1"))؛
                                        نصف_قطر_الإطار = مـسافة4.بكسلات(8)؛
                                    }؛
                                    أضف_فروع({
                                        كـتابة(نـص("الشروق")).{
                                            الطراز.{
                                                لون_الخط = لـون("2c3e50")؛
                                                حجم_الخط = مـسافة.بكسلات(16.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }،
                                        كـتابة(نـص("--:--")).{
                                            الكائن.نص_الشروق = هذا؛
                                            الطراز.{
                                                لون_الخط = لـون("e67e22")؛
                                                حجم_الخط = مـسافة.بكسلات(18.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }
                                    })؛
                                }،
                                // الظهر
                                صـندوق().{
                                    الطراز.{
                                        الإظهار = إظـهار._مرن_؛
                                        النسق = نـسق._سطر_؛
                                        ملء_السطر = مـلء_سطر._مسافة_بينية_؛
                                        الحشوة = مـسافة4.بكسلات(15)؛
                                        الخلفية = خـلفية(لـون("ecf0f1"))؛
                                        نصف_قطر_الإطار = مـسافة4.بكسلات(8)؛
                                    }؛
                                    أضف_فروع({
                                        كـتابة(نـص("الظهر")).{
                                            الطراز.{
                                                لون_الخط = لـون("2c3e50")؛
                                                حجم_الخط = مـسافة.بكسلات(16.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }،
                                        كـتابة(نـص("--:--")).{
                                            الكائن.نص_الظهر = هذا؛
                                            الطراز.{
                                                لون_الخط = لـون("f39c12")؛
                                                حجم_الخط = مـسافة.بكسلات(18.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }
                                    })؛
                                }،
                                // العصر
                                صـندوق().{
                                    الطراز.{
                                        الإظهار = إظـهار._مرن_؛
                                        النسق = نـسق._سطر_؛
                                        ملء_السطر = مـلء_سطر._مسافة_بينية_؛
                                        الحشوة = مـسافة4.بكسلات(15)؛
                                        الخلفية = خـلفية(لـون("ecf0f1"))؛
                                        نصف_قطر_الإطار = مـسافة4.بكسلات(8)؛
                                    }؛
                                    أضف_فروع({
                                        كـتابة(نـص("العصر")).{
                                            الطراز.{
                                                لون_الخط = لـون("2c3e50")؛
                                                حجم_الخط = مـسافة.بكسلات(16.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }،
                                        كـتابة(نـص("--:--")).{
                                            الكائن.نص_العصر = هذا؛
                                            الطراز.{
                                                لون_الخط = لـون("d35400")؛
                                                حجم_الخط = مـسافة.بكسلات(18.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }
                                    })؛
                                }،
                                // المغرب
                                صـندوق().{
                                    الطراز.{
                                        الإظهار = إظـهار._مرن_؛
                                        النسق = نـسق._سطر_؛
                                        ملء_السطر = مـلء_سطر._مسافة_بينية_؛
                                        الحشوة = مـسافة4.بكسلات(15)؛
                                        الخلفية = خـلفية(لـون("ecf0f1"))؛
                                        نصف_قطر_الإطار = مـسافة4.بكسلات(8)؛
                                    }؛
                                    أضف_فروع({
                                        كـتابة(نـص("المغرب")).{
                                            الطراز.{
                                                لون_الخط = لـون("2c3e50")؛
                                                حجم_الخط = مـسافة.بكسلات(16.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }،
                                        كـتابة(نـص("--:--")).{
                                            الكائن.نص_المغرب = هذا؛
                                            الطراز.{
                                                لون_الخط = لـون("c0392b")؛
                                                حجم_الخط = مـسافة.بكسلات(18.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }
                                    })؛
                                }،
                                // العشاء
                                صـندوق().{
                                    الطراز.{
                                        الإظهار = إظـهار._مرن_؛
                                        النسق = نـسق._سطر_؛
                                        ملء_السطر = مـلء_سطر._مسافة_بينية_؛
                                        الحشوة = مـسافة4.بكسلات(15)؛
                                        الخلفية = خـلفية(لـون("ecf0f1"))؛
                                        نصف_قطر_الإطار = مـسافة4.بكسلات(8)؛
                                    }؛
                                    أضف_فروع({
                                        كـتابة(نـص("العشاء")).{
                                            الطراز.{
                                                لون_الخط = لـون("2c3e50")؛
                                                حجم_الخط = مـسافة.بكسلات(16.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }،
                                        كـتابة(نـص("--:--")).{
                                            الكائن.نص_العشاء = هذا؛
                                            الطراز.{
                                                لون_الخط = لـون("8e44ad")؛
                                                حجم_الخط = مـسافة.بكسلات(18.0)؛
                                                فئة_الخط = "TajawalBold"؛
                                            }
                                        }
                                    })؛
                                }
                            })؛
                        }
                    })؛
                }
            })؛
            // إغلاق النافذة عند النقر على الخلفية
            عند_الضغط.اربط(مغلفة (سند[ودجـة]، سند[صـحيح]) {
                المكداس_الرئيسي.أزل(نـص("للخلف"))؛
            })؛
        }؛

        // استدعاء API لجلب أوقات الصلاة
        عرف رابط_الطلب: نـص = نـص.املأ(
            ‏"/api/prayer-times?day=%i&month=%i&year=%i",
            تاريخ_ميلادي.اليوم،
            تاريخ_ميلادي.الشهر،
            تاريخ_ميلادي.السنة
        )؛

        هذا.النداء.أرسل(
‏            "GET"، رابط_الطلب.صوان، 0، 0، 10000،
            مغلفة (البيانات: جـيسون) {
                // التحقق من نجاح الطلب
                إذا البيانات("eventData")("status")~مثل[صـحيح] == 200 {
                    // تحليل محتوى الرد
                    عرف المحتوى: نـص = البيانات("eventData")("body")؛
                    عرف أوقات_الصلاة: جـيسون = المحتوى؛

                    // تحديث الموقع
                    عرف المدينة: نـص = أوقات_الصلاة("city")~مثل[نـص]؛
                    عرف البلد: نـص = أوقات_الصلاة("country")~مثل[نـص]؛
                    الكائن.نص_الموقع.النص = نـص.املأ("%s، %s", المدينة.صوان، البلد.صوان)؛

                    // تحديث أوقات الصلاة في الواجهة
                    الكائن.نص_الفجر.النص = أوقات_الصلاة("fajr")~مثل[نـص]؛
                    الكائن.نص_الشروق.النص = أوقات_الصلاة("sunrise")~مثل[نـص]؛
                    الكائن.نص_الظهر.النص = أوقات_الصلاة("dhuhr")~مثل[نـص]؛
                    الكائن.نص_العصر.النص = أوقات_الصلاة("asr")~مثل[نـص]؛
                    الكائن.نص_المغرب.النص = أوقات_الصلاة("maghrib")~مثل[نـص]؛
                    الكائن.نص_العشاء.النص = أوقات_الصلاة("isha")~مثل[نـص]؛
                    // إخفاء الإشعار
                    الكائن.إشعار_التحميل.الطراز.الإظهار = إظـهار._مخفي_؛
                }
            }
        )؛
    }

    عملية هذا_الصنف(
        السنة_الهجرية: صـحيح،
        الشهر_الهجري: صـحيح،
        اليوم_الهجري: صـحيح
    ): سـندنا[نـافذة_أوقات_الصلاة] {
        أرجع سـندنا[نـافذة_أوقات_الصلاة]().{ احجز()~هيئ(السنة_الهجرية، الشهر_الهجري، اليوم_الهجري) }؛
    }
}
